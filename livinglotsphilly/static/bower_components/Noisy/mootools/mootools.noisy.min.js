var Noisy=new Class({Implements:Options,options:{intensity:0.9,size:200,opacity:0.08,fallback:"",monochrome:!1},initialize:function(a,b){a=this.element=document.id(a);if(!a)return!1;b&&this.setOptions(b)},noisify:function(a){var b=this.options,g=b.fallback,d=b.intensity,c=b.size,f=b.opacity;void 0!=a&&(a=this.getCachedUri(this.options));if(!a){if(this.hasCanvas()){var a=this.getCanvas(),e=a.getContext("2d"),d=this.getPixelIntensity(d,c),f=this.getMaxAlpha(f);a.width=a.height=c;c=e.createImageData(c,
c);this.randomizeImageData(c,d,f);a=a.toDataURL("image/png");if(0!=a.indexOf("data:image/png")||Browser.ie&&9>Browser.version&&32768<a.length)a=g}else a=this.options.fallback;this.setCachedUri(b,a)}this.element.setStyle("background-image","url("+a+")");return this},bitwiseRandomize:function(a){return~~(Math.random()*a)},updateCanvas:function(a){this.getCanvas().getContext("2d").putImageData(a,0,0);return this},randomizeImageData:function(a,b,g){var d=this.getCanvas(),c=d.getContext("2d"),f=this.options.monochrome;
if(c){for(;b--;){var c=this.bitwiseRandomize(d.width),e=this.bitwiseRandomize(d.height),c=4*(c+e*a.width),e=b%255;a.data[c]=e;a.data[c+1]=f?e:this.bitwiseRandomize(255);a.data[c+2]=f?e:this.bitwiseRandomize(255);a.data[c+3]=this.bitwiseRandomize(g)}this.updateCanvas(a)}return this},getPixelIntensity:function(a,b){return Math.round(a*Math.pow(b,2))},getMaxAlpha:function(a){return 255*a},setCachedUri:function(a,b){this.hasLocalStorage()&&localStorage.setItem(JSON.encode(a),b);return this},getCachedUri:function(a){return this.hasLocalStorage()?
localStorage.getItem(JSON.encode(a)):!1},hasLocalStorage:function(){try{return localStorage.setItem("a","a"),localStorage.removeItem("a"),!0}catch(a){return!1}},setCanvas:function(){this.canvas=document.createElement("canvas");return this},getCanvas:function(){var a=this.canvas;a||(this.setCanvas(),a=this.canvas);return a},hasCanvas:function(){return!!this.getCanvas()}});
Element.Properties.noisy={set:function(a){this.get("noisy").setOptions(a);return this},get:function(){return this.retrieve("noisy",new Noisy(this))}};Element.implement({noisify:function(a){this.get("noisy").noisify(a);return this}});