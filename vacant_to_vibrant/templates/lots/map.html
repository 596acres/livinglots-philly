{% extends "lots/map/cluster_main.html" %}
{% load i18n %}

{% block includes %}
{{ block.super }}
<script src="{{ STATIC_URL }}js/lib/jquery.infinitescroll.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/jquery.activitystream.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="{{ STATIC_URL }}js/jquery.streetview.js"></script>
{% endblock %}

{% block below_map %}

<div id="streetview-container" style="padding: 25px; display: none;">
    <div id="streetview" style="height: 300px; width: 100%;">
    </div>
    <div id="streetview-error" class="streetview">
        {% trans "Sorry, we couldn't find streetview imagery for this lot." %}
    </div>
</div>

<div class="filters grid grid-1-2">
    <form>
        {{ filters.as_p }}
    </form>
</div>
<div class="grid grid-1-2">

    {% comment %}
    XXX stop-gap, would need a more robust solution if we planned on using this
    {% endcomment %}
    <div style="margin: 15px 0;">
        <input type="checkbox" id="stop-loading" name="stop-loading" class="non-filter" />
        <label for="stop-loading">enough! stop loading data</label>
    </div>

    <div class="tally">
        You are looking at:
        <ul>
            <li><span class="lots-count">X</span> lots</li>
            <li><span class="no-known-use-count">X</span> lots with no known use</li>
            {% for use in uses %}
            <li><span class="{{ use.slug }}-count">Y</span> lots being used as a {{ use.name }}</li>
            {% endfor %}
        </ul>
    </div>

    <div class="activity-stream-section">
        <div>Recent Activities</div>
        <div class="activity-stream">
            <div class="activity-stream-container"></div>
            <div class="activity-stream-nav" style="display: none;">
                <a href="/activity-stream/">next page</a>
            </div>
        </div>
    </div>

</div>
<div class="clear"></div>

<script>

    function update_counts() {
        $.getJSON('/lots/count/?' + $('form').serialize(), function(data) {
            $.each(data, function(label, count) {
                $('.' + label).text(count);
            });
        });
    }

    $(document).ready(function() {

        update_counts();

        LOTS_MAP.on('moveend', function(e) {
            var g = JSON.stringify(LOTS_MAP.getBounds().toGeoJson())
            $(':input[name="centroid__within"]').val(
                JSON.stringify(LOTS_MAP.getBounds().toGeoJson())
            );
            update_counts();
        });

        $('#streetview-container').streetview({
            errorSelector: '#streetview-error',
        });

        LOTS_MAP.on('lotclicked', function(e) {
            $('#streetview-container').data('streetview').load_streetview(
                e.geometry.coordinates[0], e.geometry.coordinates[1]);
        });

        $(':input:not(.non-filter)').change(function() {
            $('#stop-loading').removeAttr('checked');
            update_counts();
            LOTS_MAP.reloadLotCentroidLayer($('form').serialize());
        });

        $('.activity-stream-container').activitystream();

    });
</script>
{% endblock %}
