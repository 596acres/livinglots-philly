{% extends "lots/map/choro.html" %}
{% comment %}
{% extends "lots/map/cluster_main.html" %}
{% endcomment %}
{% load i18n %}

{% block includes %}
{{ block.super }}
<script src="{{ STATIC_URL }}js/lib/jquery.infinitescroll.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/jquery.activitystream.js"></script>
<script src="{{ STATIC_URL }}js/geocode.js"></script>
<script src="{{ STATIC_URL }}js/jquery.searchbar.js"></script>
<script src="{{ STATIC_URL }}js/jquery.singleminded.js"></script>
<script src="{{ STATIC_URL }}js/lib/jquery.deserialize.min.js"></script>
<script src="{{ STATIC_URL }}js/lib/jquery.serializeobject.min.js"></script>
{{ filters.media }}
{% endblock %}

{% block below_map %}

<div id="streetview-container" style="padding: 25px; display: none;">
    <div id="streetview" style="height: 300px; width: 100%;">
    </div>
    <div id="streetview-error" class="streetview">
        {% trans "Sorry, we couldn't find streetview imagery for this lot." %}
    </div>
</div>

<div class="home-map-filters grid grid-3-4">

    {% comment %}
    Render form fields
    {% endcomment %}
    <form>
        {% for hidden_field in filters.hidden_fields %}
        {{ hidden_field }}
        {% endfor %}
    </form>

    <div class="grid grid-1-3">
        <h2>{% trans "Find a lot" %}</h2>
        <div class="searchbar">
            <form class="search">
                search: <input id="search" name="search" type="text" />
                <input type="submit" />
                <span class="loading" style="display: none;">loading</span>
                <div class="warning" style="display: none;">warning</div>
            </form>
        </div>

        <h2>{% trans "Known use" %}</h2>
        <div class="filters filters-known-use">
            <form>
                {{ filters.known_use__name__in }}
            </form>
        </div>

        {% if "lots.view_all_filters" in perms %}
        <h2>{% trans "Admin filters" %}</h2>
        <div class="filters filters-admin">
            <form>
                {% for field in filters.admin_filters %}
                <div class="filter">
                    {{ field.label }}: {{ field }}
                    <div class="help-text">{{ field.help_text|safe }}</div>
                </div>
                {% endfor %}
            </form>
        </div>
        {% endif %}

    </div>

    <div class="grid grid-1-3">
        <h2>{% trans "View" %}</h2>
        <div class="filters-view">
            (show other boundaries)
        </div>

        <h2>{% trans "Other filters" %}</h2>
        <div class="filters filters-other">
            <form>
                {% for field in filters.other_filters %}
                <div>
                    {{ field.label }}: {{ field }}
                </div>
                {% endfor %}
            </form>
        </div>
    </div>

    <div class="grid grid-1-3">
        <h2>{% trans "Who owns it" %}</h2>
        <div class="filters filters-owners">
            <form>
                {% for field in filters.owners_filters %}
                <div>
                    {{ field.label }}: {{ field }}
                </div>
                {% endfor %}
            </form>
        </div>

        <h2>{% trans "Private" %}</h2>
        <div class="filters filters-private">
            <form>
                {% for field in filters.private_filters %}
                <div>
                    {{ field.label }}: {{ field }}
                </div>
                {% endfor %}
            </form>
        </div>
    </div>

    <div class="clear"></div>

    <div class="grid">
        <div class="grid grid-2-3">
            <h2>{% trans "You are currently looking at" %}</h2>
            <div class="tally">
                <ul>
                    <li><span class="lots-count">X</span> lots</li>
                    <li><span class="no-known-use-count">X</span> lots with no known use</li>
                    {% for use in uses %}
                    <li><span class="{{ use.slug }}-count">Y</span> lots being used as a {{ use.name }}</li>
                    {% endfor %}
                </ul>
            </div>

            <h2>{% trans "Export" %}</h2>
            <div class="export">
                <ul>
                    <li>
                        <a href="#" class="export-link">
                            {% trans "Link to this view" %}
                        </a>
                    </li>
                    <li>
                        <a href="#" class="export-csv">
                            {% trans "Download a spreadsheet of this view" %}
                        </a>
                    </li>
                    <li>
                        <a href="#" class="export-geojson">
                            {% trans "Download a GeoJSON file of this view" %}
                        </a>
                    </li>
                    <li>
                        <a href="#" class="export-kml">
                            {% trans "Download a KML file of this view" %}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

</div>

<div class="grid grid-1-4">

    <div>
        <h2>{% trans "Recent News" %}</h2>
        <div>
            Fusce rutrum dui ornare erat bibendum venenatis. Maecenas blandit
            velit at eros tristique vitae auctor nibh tincidunt. Etiam et ante
            at lectus malesuada lobortis vel vel purus. Mauris sit amet nulla
            nisi, ac aliquam arcu. Mauris dapibus venenatis nisi et vestibulum.
            Mauris sed sapien orci. Class aptent taciti sociosqu ad litora
            torquent per conubia nostra, per inceptos himenaeos. Fusce mi
            sapien, consequat non vulputate ut, cursus sit amet arcu. Aliquam
            lectus eros, congue at mollis id, faucibus a ipsum. Morbi placerat
            aliquam rutrum. Nullam rhoncus turpis ipsum, sed sodales urna. Nunc
            ac neque dui, id blandit turpis. Integer id quam eu lacus imperdiet
            luctus.
        </div>
    </div>

    <div>
        <h2>{% trans "Upcoming Events" %}</h2>
        <div>
            Fusce rutrum dui ornare erat bibendum venenatis. Maecenas blandit
            velit at eros tristique vitae auctor nibh tincidunt. Etiam et ante
            at lectus malesuada lobortis vel vel purus. Mauris sit amet nulla
            nisi, ac aliquam arcu. Mauris dapibus venenatis nisi et vestibulum.
            Mauris sed sapien orci. Class aptent taciti sociosqu ad litora
            torquent per conubia nostra, per inceptos himenaeos. Fusce mi
            sapien, consequat non vulputate ut, cursus sit amet arcu. Aliquam
            lectus eros, congue at mollis id, faucibus a ipsum. Morbi placerat
            aliquam rutrum. Nullam rhoncus turpis ipsum, sed sodales urna. Nunc
            ac neque dui, id blandit turpis. Integer id quam eu lacus imperdiet
            luctus.
        </div>
    </div>

    <div class="activity-stream-section">
        <h2>{% trans "Recent Activities" %}</h2>
        <div class="activity-stream">
            <div class="activity-stream-container"></div>
            <div class="activity-stream-nav" style="display: none;">
                <a href="/activity-stream/">next page</a>
            </div>
        </div>
    </div>

    <div class="clear"></div>
</div>
<div class="clear"></div>

<script>

    function updateCounts() {
        $('#map').singleminded({
            name: 'counts',
            jqxhr: $.getJSON('/lots/count/?' + $('form').serialize(), function(data) {
                $.each(data, function(label, count) {
                    $('.' + label).text(count);
                });
            }),
        });
    }

    function serializeFilters() {
        return $('form').serialize();
    }

    function deserializeFilters() {
        // Get filters from url query string
        var filters = window.location.search.slice(1);

        // Drop filters into the form (which is spread over multiple forms)
        $('form').deserialize(filters);

        // Trigger Chosen to update selects
        $('select').trigger('liszt:updated');

        // Update map viewport
        var bboxString = $('#id_centroid__within').val();
        if (bboxString) {
            LOTS_MAP.fitBounds(L.geoJsonLatLngBounds(bboxString));
        }
    }

    function getBounds(map) {
        var bounds = map.options.maxBounds;
        var seBounds = bounds.getSouthEast();
        var nwBounds = bounds.getNorthWest();

        return [
            seBounds.lng,
            seBounds.lat,
            nwBounds.lng,
            nwBounds.lat
        ];
    }

    $(document).ready(function() {
        deserializeFilters();

        updateCounts();

        // TODO keep map from reloading itself after this happens 
        LOTS_MAP.updateFilters($('form').serializeObject());
        LOTS_MAP.reloadLotCentroidLayer(serializeFilters());
        LOTS_MAP.reloadLotChoroplethLayer(serializeFilters());

        LOTS_MAP.on('moveend', function(e) {
            var g = JSON.stringify(LOTS_MAP.getBounds().toGeoJson())
            $(':input[name="centroid__within"]').val(
                JSON.stringify(LOTS_MAP.getBounds().toGeoJson())
            );
            updateCounts();
        });

        $('#streetview-container').streetview({
            errorSelector: '#streetview-error',
        });

        LOTS_MAP.on('lotclicked', function(data) {
            var event = data.event;
            $('#streetview-container').data('streetview').load_streetview(
                event.latlng.lng, event.latlng.lat);
        });

        LOTS_MAP.on('popupclose', function(e) {
            $('#streetview-container').hide();
        });

        $('.filters :input:not(.non-filter)').change(function() {
            updateCounts();
            LOTS_MAP.reloadLotCentroidLayer(serializeFilters());
            LOTS_MAP.reloadLotChoroplethLayer(serializeFilters());
            LOTS_MAP.updateFilters($('form').serializeObject());
        });

        $('.activity-stream-container').activitystream();

        $('.searchbar')
            .searchbar({
                bounds: getBounds(LOTS_MAP),
                city: 'Philadelphia',
                state: 'PA',
                errorMessage: "Sorry, it doesn't seem that the address you " +
                    "entered is in Philadelphia. Try again?",
                loadingSelector: '.loading',
                warningSelector: '.warning',
            })
            .on('searchresultfound', function(e, data) {
                LOTS_MAP.setView([data.latitude, data.longitude], 15);
            });

        $('.export-link').click(function() {
            // TODO make shorter urls
            window.location.search = serializeFilters();
        });

        $('.export-csv').click(function() {
            window.location = '{% url "lots:csv" %}?' + serializeFilters();
            return false;
        });

        $('.export-geojson').click(function() {
            window.location = '{% url "lots:geojson" %}?download=yes&' + serializeFilters();
            return false;
        });

        $('.export-kml').click(function() {
            window.location = '{% url "lots:kml" %}?' + serializeFilters();
            return false;
        });
    });
</script>
{% endblock %}
